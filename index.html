<!DOCTYPE html>
<html lang="en">
<head>
	<title>Где еще живет скорость в web</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<base href="/node_modules/shower-ribbon/" />
	<link rel="stylesheet" href="styles/screen.css">
	<style>
		.slide>div.demoRect {
			position: absolute;
			outline: 1px solid red;
			padding: 0;
			background: #477FB7;
			opacity: 0.3;
		}
		.full .slide:not(.cover):not(.shout):before {
			content: "";
			display: block;
			width: 75px;
			height: 75px;
			position: absolute;
			right: 10px;
			bottom: 15px;
			background: url(/images/moscowjs.svg) no-repeat;
			background-size: cover;
		}
		mark.important{
			background:#C00;
			color:#FFF
		}
		.about {
			text-align: right;
		}
		.titleslide h2, .titleslide p {
			color: black;
		}

		mark.code-keyword {
			color: #0B1D8D;
			font-weight: bold;
			background: none;
			padding: 0;
		}
		mark.code-reserved {
			color: #962588;
			font-weight: bold;
			background: none;
			padding: 0;
		}
		mark.code-property {
			color: #968B5B;
			background: none;
			padding: 0;
		}
		mark.code-variable {
			color: #649595;
			background: none;
			padding: 0;
		}
		mark.code-string {
			color: #008F28;
			background: none;
			padding: 0;
		}
		mark.code-value {
			color: #1C39F6;
			background: none;
			padding: 0;
		}
	</style>
</head>
<body class="list">
	<!--
		Debug class on <body> enables
		cyan grid on slides
		-->
	<header class="caption">
		<h1>Где еще живет скорость в web</h1>
		<p><a href="mailto:oleg@elifantiev.ru">Олег Елифантьев</a></p>
	</header>

	<section class="slide cover titleslide"><div>
		<img src="/images/fast-and-furious-2.jpg" />
		<h2>Где еще живет скорость в Web</h2>
		<p>MoscowJS #24<br />Олег Елифантьев<br />@oelifantiev</p>
	</div></section>

	<section class="slide"><div>
		<h2>Олег Елифантьев</h2>
		<p>Компания Тензор, г. Ярославль<br />
		Веб-разработчик (JavaScript, Node.JS)<br />
		Организатор <a href="http://yarfrontend.ru/">Yaroslavl Frontend Meetup</a> (http://yarfrontend.ru)<br />
		<a href="https://twitter.com/oelifantiev">@oelifantiev</a>
	</div></section>

	<section class="slide"><div>
		<h2>Давайте нарисуем снежинки?</h2>
		<p><b>Менеджер</b>: К новому году на сайт клиента нужны снежинки!</p>
		<p style="text-align: right"><b>Dev</b>: Okay boss!</p>
	</div></section>

	<section class="slide"><div>
		<h2>Снежинка?</h2>
		<ul>
			<li>Простая текстовая нода</li>
			<li>position: absolute</li>
			<li>Анимируем через left, top</li>
		</ul>
	</div></section>


	<section class="slide"><div>
		<h2>Анимировать будем так...</h2>
		<pre><code><mark class="code-keyword">function</mark> animate() {
	<mark class="code-keyword">var</mark> <mark class="code-variable">col</mark> = <mark class="code-reserved">document</mark>.<mark class="code-property">querySelectorAll</mark>(<mark class="code-string">'.snowflake'</mark>);
	<mark class="code-keyword">for</mark> (<mark class="code-keyword">var</mark> <mark class="code-variable">i</mark> = <mark class="code-value">0</mark>; <mark class="code-variable">i</mark> < <mark class="code-variable">col</mark>.<mark class="code-reserved">length</mark>; <mark class="code-variable">i</mark>++) {
		<mark class="code-keyword">var</mark> <mark class="code-variable">rect</mark> = <mark class="code-variable">col</mark>[i].<mark class="code-property">getBoundingClientRect</mark>();
		<mark class="code-variable">col</mark>[i].<mark class="code-reserved">style</mark>.<mark class="code-reserved">top</mark> = ..., <mark class="code-variable">col</mark>[i].<mark class="code-reserved">style</mark>.<mark class="code-reserved">left</mark> = ...
	}
	<mark class="code-property">setTimeout</mark>(animate, <mark class="code-value">0</mark>);
}</code></pre>
	</div></section>

	<section class="slide cover" id="basicDemo1"><div>
	<iframe seamless data-params="basic#50" width="100%" height="100%" src=""></iframe>
	</div></section>


	<section class="slide shout grow" lang="ru"><div>
		<h2>Нужно больше снежинок!</h2>
	</div></section>


	<section class="slide cover" id="basicDemo2"><div>
		<iframe seamless data-params="basic#200" width="100%" height="100%" src=""></iframe>
	</div></section>

	<section class="slide"><div>
		<h2>Что происходит?</h2>
		<p>Как обычно, нам поможет DevTools</p>
		<ul>
			<li>Поймем что мерять</li>
			<li>Локализуем проблему</li>
			<li>Полечим</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Будем мерять FPS</h2>
		<img src="/images/show-fps-meter.gif" width="100%"/>
		<p style="text-align: center;" class="next">
			<img src="/images/fps-meter.png"/>
		</p>
	</div></section>


	<section class="slide"><div>
		<h2>Маловато!</h2>
		<ul>
			<li>Приемлемо &mdash; хотя бы 30fps (33 ms/frame!)</li>
			<li>Идеально &mdash; 60fps (16.6 ms/frame!)</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Почему так получилось?</h2>
		<p>Запишем все происходящее</p>
		<img src="/images/recording-profile.gif" width="100%" />
	</div></section>

	<section class="slide cover"><div>
		<img src="/images/timeline-panel.png"/>
	</div></section>

	<section class="slide shout grow"><div>
		<h2>223 ms!</h2>
	</div></section>

	<section class="slide shout"><div>
		<h2>Style<br />recalculation</h2>
	</div></section>

	<section class="slide"><div>
		<p><b>Style recalculation</b> &mdash; вычисление стилей,
			применяемых к конкретному элементу.</p>
		<p>Это <mark>дешевая операция</mark>.</p>
	</div></section>

	<section class="slide shout"><div>
		<h2>Layout</h2>
	</div></section>

	<section class="slide"><div>
		<h2>HTML</h2>
		<pre>
			<code>	&lt;body&gt;</code>
			<code>		&lt;p&gt;</code>
			<code>			Длинный текст</code>
			<code>			&lt;img align="right" src="..."/&gt;</code>
			<code>			Еще текст</code>
			<code>		&lt;/p&gt;</code>
			<code>	&lt;/body&gt;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>HTML превращается в DOM-дерево</h2>
		<pre><code>
+ body
+--	p
    +--	#text
    +-- img
    +-- #text
		</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Есть еще "дерево рендеринга"</h2>
		<img src="/images/cat.png" style="float: right" />
		<p>
			Это длинный текст, который браузер разобьет на прямоугольники (свой под каждую строку)
			в зависимости от размеров родительского
			блока, размера шрифта, гарнитуры и даже этого кота.
			Набор этих прямоугольников составит "дерево рендеринга". Тут
			еще немного текста чтобы получилось красиво&hellip;
		</p>
	</div></section>

	<section class="slide" id="demoRects"><div>
		<h2>Есть еще "дерево рендеринга"</h2>
		<img src="/images/cat.png" style="float: right" />
		<p>
			Это длинный текст, который браузер разобьет на прямоугольники (свой под каждую строку)
			в зависимости от размеров родительского
			блока, размера шрифта, гарнитуры и даже этого кота.
			Набор этих прямоугольников составит "дерево рендеринга". Тут
			еще немного текста чтобы получилось красиво&hellip;
		</p>
	</div></section>

	<section class="slide"><div>
		<p><b>Layout</b> &mdash; пересчет дерева рендеринга на основании стилей элементов и
			других входных параметров, например размера окна браузера.</p>
		<p>Это <mark class="important">дорогая операция!</mark></p>
	</div></section>

	<section class="slide"><div>
		<h2>Что приводит к инвалидации дерева рендеринга?</h2>
		<ul>
			<li>Изменение определенных стилей элемента
				<ul>
					<li>Размер, гарнитура шрифта</li>
					<li>Геометрия (width, height, margin, etc&hellip;)</li>
					<li>etc&hellip;</li>
				</ul>
			</li>
			<li>Изменение DOM-дерева</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Оптимизации&hellip;</h2>
		<p>Браузер всячески старается оптимизировать процесс.
			Например, он <mark>откладывает</mark> применение стилей и пересчет дерева рендеринга
		до окончания синхронного блока JavaScript. Таким образом он "пакетирует" несколько изменений в один расчет.</p>
	</div></section>

	<section class="slide"><div>
		<h2>Ложка дегтя</h2>
		<p>Но если в коде мы начинаем читать стилевую информацию,
			браузеру приходится применить <mark>все</mark> отложенные расчеты <mark>здесь и сейчас</mark>
		для того, чтобы ответить на наш запрос.</p>
		<p>Это происходит синхронно. Все прочие процессы блокируются! Эффект сравним с работой Garbage Сollector.</p>
	</div></section>

	<section class="slide cover"><div>
		<img src="/images/timeline-panel.png"/>
	</div></section>

	<section class="slide"><div>
		<h2>Что приводит к "чтению стилей"</h2>
		<ul>
			<li><mark class="code-property">getComputedStyle</mark>(<mark class="code-variable">elt</mark>)</li>
			<li><mark class="code-variable">elt</mark>.<mark class="code-reserved">style</mark>.???</li>
			<li><mark class="code-variable">elt</mark>.<mark class="code-property">getBoundingClientRect</mark>()</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Вернемся к нашей анимации</h2>
		<pre><code><mark class="code-keyword">var</mark> <mark class="code-variable">col</mark> = <mark class="code-reserved">document</mark>.<mark class="code-property">querySelectorAll</mark>(<mark class="code-string">'.snowflake'</mark>);
<mark class="code-keyword">for</mark> (<mark class="code-keyword">var</mark> <mark class="code-variable">i</mark> = <mark class="code-value">0</mark>; <mark class="code-variable">i</mark> < <mark class="code-variable">col</mark>.<mark class="code-reserved">length</mark>; <mark class="code-variable">i</mark>++) {
	<mark class="comment">// read one, forced layout</mark>
	<mark class="code-keyword">var</mark> <mark class="code-variable">rect</mark> = <mark class="code-variable">col</mark>[i].<mark>getBoundingClientRect</mark>();
	<mark class="comment">// write one, layout invalidated</mark>
	<mark class="code-variable">col</mark>[i].<mark class="code-reserved">style</mark>.<mark class="code-reserved">top</mark> = ..., <mark class="code-variable">col</mark>[i].<mark class="code-reserved">style</mark>.<mark class="code-reserved">left</mark> = ...
}</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>Как исправить?</h2>
		<p>Все очень просто!</p>
		<p>Нужно сначала все прочитать, а потом все записать!</p>
		<p class="note">Спасибо, Кэп!</p>
	</div></section>

	<section class="slide"><div>
		<pre><code><mark class="code-keyword">function</mark> animate() {
	<mark class="code-keyword">var</mark> <mark class="code-variable">col</mark> = <mark class="code-reserved">document</mark>.<mark class="code-property">querySelectorAll</mark>(<mark class="code-string">'.snowflake'</mark>);
	[].<mark class="code-property">slice</mark>.<mark class="code-property">call</mark>(<mark class="code-variable">col</mark>)
		<mark class="comment">// read all</mark>
		<mark>.map(readCoordinates)</mark>
		.<mark class="code-property">map</mark>(<mark class="code-variable">applyAnimationStep</mark>)
		<mark class="comment">// write all</mark>
		<mark class="important">.forEach(applyToDOM);</mark>
	<mark class="code-property">setTimeout</mark>(animate, <mark class="code-value">0</mark>);
}</code></pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="/images/fast-timeline-panel.png"/>
	</div></section>

	<section class="slide shout"><div>
		<h2>Было</h2>
	</div></section>

	<section class="slide cover" id="basicDemo3"><div>
		<iframe seamless data-params="basic#200" width="100%" height="100%" src=""></iframe>
	</div></section>

	<section class="slide shout"><div>
		<h2>Стало</h2>
	</div></section>

	<section class="slide cover" id="fastDemo1"><div>
		<iframe seamless data-params="fast#200" width="100%" height="100%" src=""></iframe>
	</div></section>

	<section class="slide cover" id="fastDemo2"><div>
		<iframe seamless data-params="fast#300" width="100%" height="100%" src=""></iframe>
	</div></section>

	<section class="slide shout"><div>
		<h2>Paint</h2>
	</div></section>

	<section class="slide"><div>
		<h2>Еще раз посмотрим на Timeline</h2>
		<img src="/images/too-much-paint.png" width="100%" />
		<p class="next">Включаем "Show paint rectangles"</p>
	</div></section>

	<section class="slide cover"><div>
		<img src="/images/paint-rectangles.gif" />
	</div></section>

	<section class="slide"><div>
		<h2>Что делать? Заставим трудиться GPU!</h2>
		<p>Вместо left и top для перемещения используем CSS Transforms</p>
		<pre><code><mark class="code-value">transform</mark>: <mark class="code-string">translate3d</mark>(x, y, z);
		</code></pre>
	</div></section>

	<section class="slide cover"><div>
		<img src="/images/translate3d-paint.gif" />
	</div></section>

	<section class="slide shout">
		<h2>Экономная анимация</h2>
	</section>

	<section class="slide"><div>
		<h2>requestAnimationFrame!</h2>
		<ul>
			<li class="next">Экономит CPU</li>
			<li class="next">Делает анимацию более плавной</li>
			<li class="next">Дает "привязку ко времени"</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Используем знание о времени!</h2>
		<pre><code>function animate(ts) {
	<mark class="code-keyword">var</mark> <mark class="code-variable">col</mark> = <mark class="code-reserved">document</mark>.<mark class="code-property">querySelectorAll</mark>(<mark class="code-string">'.snowflake'</mark>);
	[].<mark class="code-property">slice</mark>.<mark class="code-property">call</mark>(<mark class="code-variable">col</mark>)
		.<mark class="code-property">map</mark>(<mark>calculateNextPosition(ts)</mark>)
		.<mark class="code-property">forEach</mark>(<mark class="code-variable">applyToDOM</mark>);
	<mark>requestAnimationFrame(animate);</mark>
}</code></pre>
	</div></section>

	<section class="slide shout"><div>
		<h2>will-change</h2>
	</div></section>

	<section class="slide"><div>
		<h2>CSS-свойство "will-change"</h2>
		<p>Позволяет подсказать браузеру, что будет происходить с элементом. Браузер может использовать
		для оптимизаций</p>
		<pre><code><mark class="code-keyword">.someElt</mark> { ... }
<mark class="code-keyword">.someElt:hover</mark> { <mark class="code-value">will-change</mark>: <mark class="code-string">transform</mark>; }
<mark class="code-keyword">.someElt:active</mark> { <mark class="code-value">transform</mark>: <mark class="code-string">rotate(90deg)</mark>; }
		</code></pre>
	</div></section>

	<section class="slide"><div>
		<h2>will-change ?</h2>
		<p>Опыт автора: Chrome 43 &mdash; эффект сомнительный.</p>
	</div></section>

	<section class="slide"><div>
		<h2>Disclaimer :)</h2>
		<p>Почти все это актуально не только для анимации! Любой код, работающий с DOM может выиграть!</p>
		<ul>
			<li class="next">Сначала чтение, затем запись</li>
			<li class="next">transform: translate3d</li>
			<li class="next">requestAnimationFrame</li>
			<li class="next">will-change</li>
			<li class="next">И не забывайте про DevTools!</li>
		</ul>
	</div></section>

	<section class="slide">
		<div>
			<h2>Спасибо за внимание!</h2>
			<p>Вопросы?</p>
			<p class="about">
				MoscowJS #24<br />
				Елифантьев Олег, Тензор<br />
				<a href="https://twitter.com/oelifantiev">@oelifantiev</a>
			</p>
		</div>
	</section>

	<p class="badge"><a href="https://github.com/Olegas/talks-improve-rendering-speed">Fork me on Github</a></p>
	<!--
		To hide progress bar from entire presentation
		just remove “progress” element.
		-->
	<div class="progress"><div></div></div>
	<script src="../shower-core/shower.min.js"></script>
	<script src="/js/slide-handlers.js"></script>
</body>
</html>
